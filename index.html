<script>
// ... ×”×©××¨ × ×©××¨ ...

function matchPlate(normalized){
  const hits = [];
  for (const p of DB) {
    for (const re of p.regexes) {
      if (re.test(normalized)) {
        if (p.code === 'CH') {
          const m = normalized.match(/^([A-Z]{2})\d{1,6}$/);
          if (m && p.canton && p.canton.includes(m[1])) {
            hits.push({ ...p, confidence: 96, rationale: `×ª×‘× ×™×ª ××œ××” + ×§× ×˜×•×Ÿ ×—×•×§×™ (${m[1]}).` });
          } else {
            hits.push({ ...p, confidence: 70, rationale: '×ª×‘× ×™×ª ×©×•×•×™×¦×¨×™×ª ××š ×§×™×“×•××ª ×§× ×˜×•×Ÿ ×œ× ××–×•×”×”.' });
          }
          continue;
        }
        hits.push({ ...p, confidence: 86, rationale: '×”×ª×××” ××œ××” ×œ×ª×‘× ×™×ª ×”×¨×©××™×ª/×”× ×¤×•×¦×”.' });
        break;
      }
    }
  }
  if (!hits.length) {
    if (/^[A-Z]{1,3}[A-Z]{1,2}\d{1,4}$/.test(normalized)) {
      hits.push({code:'D',flag:'ğŸ‡©ğŸ‡ª',country:'×’×¨×× ×™×”',confidence:60,rationale:'××‘× ×” ×“××•×™ ×’×¨×× ×™ ×œ×œ× ××¤×¨×™×“×™×.',notes:'×§×™×“×•××ª ×¢×™×¨ 1â€“3 ××•×ª×™×•×ª, 1â€“2 ××•×ª×™×•×ª ×•-1â€“4 ×¡×¤×¨×•×ª.'});
    }
    if (/^\d{4}[A-Z]{3}$/.test(normalized)) {
      hits.push({code:'E',flag:'ğŸ‡ªğŸ‡¸',country:'×¡×¤×¨×“',confidence:60,rationale:'××‘× ×” ×¡×¤×¨×“×™ ×œ×œ× ××¤×¨×™×“×™×.',notes:'4 ×¡×¤×¨×•×ª + 3 ××•×ª×™×•×ª (×œ×œ× I,O,U,Q).'});
    }
  }
  return hits;
}

// ×¢×“×›×•×Ÿ ×”×¨×™× ×“×•×¨ + ×”×¢×“×¤×ª ××™×˜×œ×™×” ×›×©×™×© ×ª×™×§×• ××•×œ ×¦×¨×¤×ª
function renderResult(resList, raw, normalized){
  const el = $('#result');
  if (!resList || !resList.length) {
    el.innerHTML = '<div class="muted">×œ× ×–×•×”×” ×¤×•×¨××˜. × ×¡×” ×œ×”×•×¡×™×£/×œ×”×¡×™×¨ ××§×¤×™× ××• ×¨×•×•×—×™×.</div>';
    setPreview(raw, 'EU');
    return;
  }

  // ×›×œ×œ ×”×›×¨×¢×”: ×× ×™×© ×’× IT ×•×’× FR
  const codes = new Set(resList.map(r => r.code));
  let ordered = [...resList].sort((a,b)=>(b.confidence||0)-(a.confidence||0));

  if (codes.has('I') && codes.has('F')) {
    const hasHyphens = /-/.test(raw);         // ×§×œ×˜ ×¢× ××§×¤×™× â€“ × ×˜×™×™×” ×œ×¦×¨×¤×ª
    const isFrenchTemp = /^WW/.test(normalized); // WW* ×¦×¨×¤×ª×™ ×–×× ×™
    if (isFrenchTemp || hasHyphens) {
      // ×©×™× ××ª ×¦×¨×¤×ª ×¨××©×•× ×”
      ordered.sort((a,b)=> (a.code==='F'? -1: 0) + (b.code==='F'? 1: 0));
    } else {
      // ×‘×œ×™ ××§×¤×™×/WW â€“ ×”×¢×“×£ ××™×˜×œ×™×”
      ordered.sort((a,b)=> (a.code==='I'? -1: 0) + (b.code==='I'? 1: 0));
    }
  }

  const top = ordered[0];
  setPreview(raw, top.code);

  const rows = ordered.slice(0,3).map(r=>`
    <div class="row" style="align-items:center;gap:8px;margin-top:6px">
      <span class="badge"><span class="flag">${r.flag||'ğŸŒ'}</span>${r.country}</span>
      <span class="badge">${r.code}</span>
      <span class="hint">${r.rationale||''}</span>
      <span class="hint">(${r.confidence||''}%)</span>
    </div>`).join('');

  el.innerHTML = `
    <div class="hint">××•×¢××“×™× ××•×‘×™×œ×™× (×¢×“ 3):</div>
    ${rows}
    <div class="pill" style="margin-top:8px"><span style="width:${top.confidence||80}%"></span></div>
    <div class="hint" style="margin-top:6px">×¨××ª ×‘×™×˜×—×•×Ÿ ××•×‘×™×œ: ${top.confidence||80}%</div>
    ${top.notes?`<div class="hint" style="margin-top:6px">×”×¢×¨×•×ª: ${top.notes}</div>`:''}
    <div class="hint" style="margin-top:10px">×× ×•×¨××œ: <span class="mono">${normalized}</span></div>
  `;
}
</script>
